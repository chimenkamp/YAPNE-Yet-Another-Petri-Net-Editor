#!/usr/bin/env node
/**
 * WebPPL Browser Bundle Builder
 * 
 * Creates a browser-compatible bundle of WebPPL for use in YAPNE.
 * This enables true probabilistic inference via WebPPL in the browser,
 * as required by the paper "Data Petri Nets Meet Probabilistic Programming"
 * (Kuhn et al., BPM 2024, https://doi.org/10.1007/978-3-031-70396-6_2)
 * 
 * Usage: node scripts/bundle-webppl.js
 * Output: public/webppl/webppl-bundle.js
 */

import { execSync } from 'child_process';
import { mkdirSync, existsSync, writeFileSync, readFileSync } from 'fs';
import { dirname, join } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');

const OUTPUT_DIR = join(projectRoot, 'public', 'webppl');
const OUTPUT_FILE = join(OUTPUT_DIR, 'webppl-bundle.js');
const WEBPPL_DIR = join(projectRoot, 'node_modules', 'webppl');

console.log('=== WebPPL Browser Bundle Builder ===\n');

// Ensure output directory exists
if (!existsSync(OUTPUT_DIR)) {
    mkdirSync(OUTPUT_DIR, { recursive: true });
    console.log(`Created output directory: ${OUTPUT_DIR}`);
}

// Check if browserify is available
try {
    execSync('npx browserify --version', { stdio: 'pipe' });
} catch (error) {
    console.log('Installing browserify...');
    execSync('npm install --save-dev browserify', { stdio: 'inherit' });
}

// Install brfs if not available (required by WebPPL for inlining files)
try {
    execSync('npx brfs --help', { stdio: 'pipe' });
} catch {
    console.log('Installing brfs (required by WebPPL)...');
    execSync('npm install --save-dev brfs', { stdio: 'inherit' });
}

// Find WebPPL browser entry point
const webpplBrowserJs = join(WEBPPL_DIR, 'src', 'browser.js');
const webpplBundleTransform = join(WEBPPL_DIR, 'src', 'bundle.js');

if (!existsSync(webpplBrowserJs)) {
    console.error(`Error: WebPPL browser.js not found at ${webpplBrowserJs}`);
    console.error('Please ensure webppl is installed: npm install webppl');
    process.exit(1);
}

console.log(`Found WebPPL at: ${WEBPPL_DIR}`);
console.log('Bundling WebPPL for browser...\n');

try {
    // Bundle using browserify following WebPPL's Gruntfile.js approach:
    // - Use brfs for file inlining
    // - Use WebPPL's bundle.js transform
    // - Exclude mongodb (optional dependency)
    // - Do NOT use --standalone since browser.js sets global.webppl directly
    
    const browserifyCmd = [
        'npx browserify',
        `"${webpplBrowserJs}"`,
        `-t brfs`,
        `-t "${webpplBundleTransform}"`,
        `-x mongodb`,   // Exclude optional mongodb
        `-x aws-sdk`,   // Exclude optional aws-sdk
        `-o "${OUTPUT_FILE}"`
    ].join(' ');

    console.log('Running browserify (this may take a moment)...');
    console.log(`Command: ${browserifyCmd}\n`);
    
    execSync(browserifyCmd, { 
        stdio: 'inherit',
        cwd: WEBPPL_DIR  // Run from webppl directory so transforms work correctly
    });

    // Read the generated bundle to verify and add header
    let bundleContent = readFileSync(OUTPUT_FILE, 'utf8');
    
    // Add header comment
    const header = `/**
 * WebPPL Browser Bundle for YAPNE
 * 
 * Auto-generated by scripts/bundle-webppl.js
 * DO NOT EDIT MANUALLY
 * 
 * WebPPL: https://webppl.org/
 * Paper: "Data Petri Nets Meet Probabilistic Programming" (Kuhn et al., BPM 2024)
 * 
 * Usage:
 *   window.webppl.run(code, function(err, result) { console.log(result); });
 */
`;
    
    bundleContent = header + bundleContent;
    writeFileSync(OUTPUT_FILE, bundleContent);

    const stats = readFileSync(OUTPUT_FILE);
    const sizeMB = (stats.length / (1024 * 1024)).toFixed(2);
    
    console.log(`\nâœ“ Bundle created: ${OUTPUT_FILE}`);
    console.log(`  Size: ${sizeMB} MB`);
    console.log('\nTo use WebPPL in the browser:');
    console.log('  1. The bundle is already loaded in index.html');
    console.log('  2. Access via window.webppl.run(code, callback)');
    
} catch (error) {
    console.error('Error bundling WebPPL:', error.message);
    console.error('\nTroubleshooting:');
    console.error('  1. Ensure browserify is installed: npm install --save-dev browserify');
    console.error('  2. Ensure brfs is installed: npm install --save-dev brfs');
    console.error('  3. Try running: npx browserify --help');
    process.exit(1);
}
